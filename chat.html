<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat - Oodles & Doodles</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ”¥</text></svg>">
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --pink: #ff006e;
      --purple: #8338ec;
      --dark: #050818;
      --dark-card: #0b1024;
      --dark-input: #0a0e1f;
      --border: #272b4a;
      --text: #f5f5f5;
      --text-muted: #9aa3ff;
      --text-dim: #b0b8d0;
      --gradient: linear-gradient(135deg, var(--pink), var(--purple));
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--dark);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    a { color: inherit; text-decoration: none; }

    /* â”€â”€ Top Bar â”€â”€ */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.6rem 1.25rem;
      background: var(--dark-card);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .topbar-logo {
      font-weight: 700;
      font-size: 0.95rem;
      background: var(--gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .topbar-nav {
      display: flex;
      gap: 0.25rem;
    }
    .topbar-nav a {
      padding: 0.4rem 0.75rem;
      border-radius: 999px;
      font-size: 0.8rem;
      color: var(--text-muted);
      transition: all 0.2s;
    }
    .topbar-nav a:hover { color: var(--text); }
    .topbar-nav a.active {
      background: var(--gradient);
      color: white;
      font-weight: 600;
    }
    .topbar-actions {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .topbar-actions button {
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      color: var(--text-dim);
      padding: 0.3rem 0.6rem;
      border-radius: 999px;
      font-size: 0.75rem;
      cursor: pointer;
    }

    /* â”€â”€ Chat Layout â”€â”€ */
    .chat-layout {
      flex: 1;
      display: grid;
      grid-template-columns: 280px 1fr;
      min-height: 0;
    }
    @media (max-width: 768px) {
      .chat-layout { grid-template-columns: 1fr; }
      .chat-sidebar { display: none; }
      .chat-sidebar.mobile-open { display: flex; position: fixed; top: 48px; left: 0; right: 0; bottom: 0; z-index: 30; }
    }

    /* â”€â”€ Sidebar â”€â”€ */
    .chat-sidebar {
      background: var(--dark-card);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .chat-sidebar-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
    }
    .chat-sidebar-header h2 {
      font-size: 1rem;
      margin-bottom: 0.25rem;
    }
    .chat-sidebar-header p {
      font-size: 0.75rem;
      color: var(--text-muted);
    }
    .chat-sidebar-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
    }
    .sidebar-convo {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.6rem;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.2s;
      margin-bottom: 0.25rem;
    }
    .sidebar-convo:hover, .sidebar-convo.active {
      background: rgba(255, 0, 110, 0.08);
    }
    .sidebar-convo-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      overflow: hidden;
      flex-shrink: 0;
    }
    .sidebar-convo-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .sidebar-convo-info { flex: 1; min-width: 0; }
    .sidebar-convo-name { font-weight: 600; font-size: 0.85rem; }
    .sidebar-convo-preview {
      font-size: 0.7rem;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* â”€â”€ Chat Main â”€â”€ */
    .chat-main {
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    .chat-header {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--dark-card);
      flex-shrink: 0;
    }
    .chat-header-info {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }
    .chat-header-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      overflow: hidden;
    }
    .chat-header-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .chat-header-name { font-weight: 600; font-size: 0.95rem; }
    .chat-header-meta { font-size: 0.75rem; color: var(--text-muted); }
    .chat-header-actions {
      display: flex;
      gap: 0.4rem;
    }
    .chat-header-actions button {
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      color: var(--text-dim);
      padding: 0.3rem 0.6rem;
      border-radius: 999px;
      font-size: 0.7rem;
      cursor: pointer;
    }

    /* â”€â”€ Messages â”€â”€ */
    .chat-messages {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .system-note {
      text-align: center;
      font-size: 0.7rem;
      color: var(--text-muted);
      padding: 0.5rem;
      background: rgba(255, 0, 110, 0.04);
      border-radius: 8px;
      margin-bottom: 0.5rem;
    }
    .message {
      max-width: 75%;
      padding: 0.6rem 0.8rem;
      border-radius: 14px;
      font-size: 0.9rem;
      word-wrap: break-word;
      line-height: 1.4;
    }
    .message.sent {
      align-self: flex-end;
      background: var(--gradient);
      color: white;
      border-bottom-right-radius: 4px;
    }
    .message.received {
      align-self: flex-start;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      border-bottom-left-radius: 4px;
    }
    .message img {
      max-width: 240px;
      border-radius: 10px;
      display: block;
      margin-bottom: 0.3rem;
    }
    .message .time {
      font-size: 0.65rem;
      opacity: 0.6;
      display: block;
      margin-top: 0.2rem;
      text-align: right;
    }

    /* â”€â”€ Input â”€â”€ */
    .chat-input-area {
      border-top: 1px solid var(--border);
      padding: 0.6rem 0.75rem;
      background: var(--dark-card);
      flex-shrink: 0;
    }
    .chat-input-tools {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-bottom: 0.4rem;
    }
    .chat-input-tools label {
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    .chat-input-tools input[type="file"] { display: none; }
    .chat-input-row {
      display: flex;
      gap: 0.5rem;
    }
    .chat-input-row input[type="text"] {
      flex: 1;
      padding: 0.6rem 1rem;
      background: var(--dark-input);
      border: 1px solid var(--border);
      border-radius: 999px;
      color: var(--text);
      font-size: 0.9rem;
      font-family: inherit;
    }
    .chat-input-row input[type="text"]::placeholder { color: var(--text-muted); }
    .chat-input-row button {
      padding: 0 1.25rem;
      background: var(--gradient);
      border: none;
      border-radius: 999px;
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .pending-image-preview {
      display: none;
      padding: 0.4rem;
      font-size: 0.75rem;
      color: var(--green);
    }

    .empty-chat {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 0.9rem;
      text-align: center;
      padding: 2rem;
    }
  </style>
</head>
<body>

  <!-- Top Bar -->
  <header class="topbar">
    <a href="/" class="topbar-logo">oodles&doodles</a>
    <nav class="topbar-nav">
      <a href="dashboard.html">Profile</a>
      <a href="dashboard.html" onclick="localStorage.setItem('oodles_nav','browse')">Browse</a>
      <a href="#" class="active">Messages</a>
    </nav>
    <div class="topbar-actions">
      <button onclick="goBack()">Back to Dashboard</button>
    </div>
  </header>

  <!-- Chat Layout -->
  <div class="chat-layout">
    <!-- Sidebar -->
    <aside class="chat-sidebar" id="chatSidebar">
      <div class="chat-sidebar-header">
        <h2>Conversations</h2>
        <p>Ephemeral &mdash; messages vanish on logout.</p>
      </div>
      <div class="chat-sidebar-list" id="sidebarConvoList">
        <div style="padding:1rem;text-align:center;color:var(--text-muted);font-size:0.8rem;">Loading...</div>
      </div>
    </aside>

    <!-- Chat Main -->
    <div class="chat-main" id="chatMain">
      <div class="chat-header" id="chatHeader">
        <div class="chat-header-info">
          <div class="chat-header-avatar" id="chatAvatar">
            <span id="chatAvatarFallback">ðŸ˜Š</span>
            <img id="chatAvatarImg" alt="" style="display:none;">
          </div>
          <div>
            <div class="chat-header-name" id="chatName">Loading...</div>
            <div class="chat-header-meta" id="chatMeta"></div>
          </div>
        </div>
        <div class="chat-header-actions">
          <button onclick="blockUser()">Block</button>
          <button onclick="reportUser()">Report</button>
        </div>
      </div>

      <div class="chat-messages" id="chatMessages">
        <div class="system-note">
          Messages are ephemeral and private. They disappear when you log out. Screenshots are strongly discouraged.
        </div>
      </div>

      <div class="chat-input-area">
        <div class="chat-input-tools">
          <label for="imageInput">ðŸ“· Attach image
            <input type="file" id="imageInput" accept="image/jpeg,image/png,image/webp">
          </label>
          <span class="pending-image-preview" id="pendingPreview"></span>
        </div>
        <form class="chat-input-row" id="chatForm">
          <input type="text" id="chatInput" placeholder="Say something..." autocomplete="off">
          <button type="submit">Send</button>
        </form>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, collection, addDoc,
      query, where, orderBy, onSnapshot, getDocs, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import {
      getStorage, ref as storageRef, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBVqDVruufVu5AvXBitSoukogADaopR-7A",
      authDomain: "oodlesanddoodles-c9202.firebaseapp.com",
      projectId: "oodlesanddoodles-c9202",
      storageBucket: "oodlesanddoodles-c9202.firebasestorage.app",
      messagingSenderId: "351292337624",
      appId: "1:351292337624:web:5ab5d5bf37b800d0da96ad"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let currentUser = null;
    let otherUser = null;
    let chatId = null;
    let unsubMessages = null;
    let pendingImageFile = null;

    function getParam(name) {
      return new URL(window.location.href).searchParams.get(name);
    }

    function getChatId(uid1, uid2) {
      return [uid1, uid2].sort().join('_');
    }

    async function fetchUserByUid(uid) {
      // Try direct doc first
      const directDoc = await getDoc(doc(db, 'users', uid));
      if (directDoc.exists()) return { id: directDoc.id, ...directDoc.data() };

      // Fallback: query
      const q = query(collection(db, 'users'), where('uid', '==', uid));
      const snap = await getDocs(q);
      if (!snap.empty) return { id: snap.docs[0].id, ...snap.docs[0].data() };
      return null;
    }

    function formatTime(ts) {
      if (!ts) return '';
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function scrollToBottom() {
      const el = document.getElementById('chatMessages');
      el.scrollTop = el.scrollHeight;
    }

    // â”€â”€â”€ Render Header â”€â”€â”€
    function renderHeader() {
      if (!otherUser) return;
      const name = otherUser.profileName || otherUser.name || 'Anonymous';
      const age = otherUser.age ? `, ${otherUser.age}` : '';
      const loc = otherUser.location || 'Somewhere nearby';
      const photo = otherUser.photoURL || '';

      document.getElementById('chatName').textContent = `${name}${age}`;
      document.getElementById('chatMeta').textContent = loc;

      if (photo) {
        document.getElementById('chatAvatarImg').src = photo;
        document.getElementById('chatAvatarImg').style.display = 'block';
        document.getElementById('chatAvatarFallback').style.display = 'none';
      }
    }

    // â”€â”€â”€ Ensure Chat Document â”€â”€â”€
    async function ensureChatDoc() {
      if (!currentUser || !otherUser) return;
      chatId = getChatId(currentUser.uid, otherUser.uid);
      const chatRef = doc(db, 'ephemeralChats', chatId);
      const snap = await getDoc(chatRef);

      if (!snap.exists()) {
        await setDoc(chatRef, {
          participants: [currentUser.uid, otherUser.uid],
          createdAt: serverTimestamp(),
          lastActivity: serverTimestamp()
        });
      }

      subscribeToMessages();
    }

    // â”€â”€â”€ Subscribe to Messages â”€â”€â”€
    function subscribeToMessages() {
      if (!chatId) return;
      const msgsRef = collection(db, 'ephemeralChats', chatId, 'messages');
      const q = query(msgsRef, orderBy('createdAt', 'asc'));
      const container = document.getElementById('chatMessages');

      if (unsubMessages) unsubMessages();

      unsubMessages = onSnapshot(q, (snap) => {
        // Keep system note
        const systemNote = container.querySelector('.system-note');
        container.innerHTML = '';
        if (systemNote) container.appendChild(systemNote);

        snap.forEach(docSnap => {
          const msg = docSnap.data();
          const div = document.createElement('div');
          const isMine = msg.fromUid === currentUser.uid;
          div.className = 'message ' + (isMine ? 'sent' : 'received');

          let html = '';
          if (msg.imageUrl) {
            html += `<img src="${msg.imageUrl}" alt="Image">`;
          }
          if (msg.text) {
            html += `<span>${escapeHtml(msg.text)}</span>`;
          }
          html += `<span class="time">${formatTime(msg.createdAt)}</span>`;
          div.innerHTML = html;
          container.appendChild(div);
        });
        scrollToBottom();
      });
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // â”€â”€â”€ Send Message â”€â”€â”€
    async function sendMessage(text) {
      if (!currentUser || !otherUser || !chatId) return;
      const trimmed = (text || '').trim();
      if (!trimmed && !pendingImageFile) return;

      let imageUrl = null;
      if (pendingImageFile) {
        if (pendingImageFile.size > 10 * 1024 * 1024) {
          alert('Max 10 MB for images.');
          return;
        }
        const allowed = ['image/jpeg', 'image/png', 'image/webp'];
        if (!allowed.includes(pendingImageFile.type)) {
          alert('JPG, PNG, or WEBP only.');
          return;
        }
        try {
          const path = `chatMedia/${chatId}/${Date.now()}_${pendingImageFile.name}`;
          const ref = storageRef(storage, path);
          await uploadBytes(ref, pendingImageFile);
          imageUrl = await getDownloadURL(ref);
        } catch (e) {
          console.error(e);
          alert('Image upload failed. Try again.');
          return;
        }
      }

      const msgsRef = collection(db, 'ephemeralChats', chatId, 'messages');
      await addDoc(msgsRef, {
        fromUid: currentUser.uid,
        toUid: otherUser.uid,
        text: trimmed || null,
        imageUrl: imageUrl || null,
        createdAt: serverTimestamp()
      });

      // Update last activity
      await setDoc(doc(db, 'ephemeralChats', chatId), { lastActivity: serverTimestamp() }, { merge: true });

      pendingImageFile = null;
      document.getElementById('imageInput').value = '';
      document.getElementById('pendingPreview').style.display = 'none';
    }

    // â”€â”€â”€ Load Sidebar Conversations â”€â”€â”€
    async function loadSidebarConvos() {
      if (!currentUser) return;
      const list = document.getElementById('sidebarConvoList');

      try {
        const chatsRef = collection(db, 'ephemeralChats');
        const snap = await getDocs(chatsRef);
        const convos = [];

        for (const chatDoc of snap.docs) {
          const data = chatDoc.data();
          if (!data.participants || !data.participants.includes(currentUser.uid)) continue;
          const otherUid = data.participants.find(p => p !== currentUser.uid);
          if (!otherUid) continue;

          const other = await fetchUserByUid(otherUid);
          convos.push({
            otherUid,
            name: other?.profileName || other?.name || 'Anonymous',
            photo: other?.photoURL || '',
            chatDocId: chatDoc.id
          });
        }

        if (convos.length === 0) {
          list.innerHTML = '<div style="padding:1rem;text-align:center;color:var(--text-muted);font-size:0.8rem;">No conversations yet</div>';
          return;
        }

        list.innerHTML = '';
        const targetUid = getParam('uid');
        convos.forEach(c => {
          const item = document.createElement('div');
          item.className = 'sidebar-convo' + (c.otherUid === targetUid ? ' active' : '');
          item.onclick = () => { window.location.href = `/chat.html?uid=${encodeURIComponent(c.otherUid)}`; };
          item.innerHTML = `
            <div class="sidebar-convo-avatar">
              ${c.photo ? `<img src="${c.photo}" alt="${c.name}">` : 'ðŸ˜Š'}
            </div>
            <div class="sidebar-convo-info">
              <div class="sidebar-convo-name">${c.name}</div>
              <div class="sidebar-convo-preview">Tap to chat</div>
            </div>
          `;
          list.appendChild(item);
        });
      } catch (err) {
        console.error(err);
      }
    }

    // â”€â”€â”€ UI Handlers â”€â”€â”€
    document.getElementById('chatForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const input = document.getElementById('chatInput');
      await sendMessage(input.value);
      input.value = '';
    });

    document.getElementById('imageInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      pendingImageFile = file || null;
      const preview = document.getElementById('pendingPreview');
      if (file) {
        preview.textContent = `ðŸ“Ž ${file.name}`;
        preview.style.display = 'inline';
      } else {
        preview.style.display = 'none';
      }
    });

    window.goBack = () => { window.location.href = '/dashboard.html'; };
    window.blockUser = () => { alert('User blocked. They will no longer be able to message you.'); };
    window.reportUser = () => { alert('Report submitted. Our team will review this within 24 hours.'); };

    // â”€â”€â”€ Auth State â”€â”€â”€
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = '/auth.html';
        return;
      }
      currentUser = user;

      const otherUid = getParam('uid');
      if (!otherUid) {
        alert('No chat partner specified.');
        window.location.href = '/dashboard.html';
        return;
      }
      if (otherUid === currentUser.uid) {
        alert('You cannot chat with yourself.');
        window.location.href = '/dashboard.html';
        return;
      }

      otherUser = await fetchUserByUid(otherUid);
      if (!otherUser) {
        alert('User not found.');
        window.location.href = '/dashboard.html';
        return;
      }

      renderHeader();
      await ensureChatDoc();
      await loadSidebarConvos();
    });
  </script>
</body>
</html>
