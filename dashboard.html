<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - Oodles & Doodles</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üî•</text></svg>">
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --pink: #ff006e;
      --purple: #8338ec;
      --dark: #050818;
      --dark-card: #0b1024;
      --dark-input: #0a0e1f;
      --border: #272b4a;
      --text: #f5f5f5;
      --text-muted: #9aa3ff;
      --text-dim: #b0b8d0;
      --green: #51cf66;
      --gradient: linear-gradient(135deg, var(--pink), var(--purple));
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--dark);
      color: var(--text);
      min-height: 100vh;
    }
    a { color: inherit; text-decoration: none; }

    /* ‚îÄ‚îÄ Top Bar ‚îÄ‚îÄ */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1.5rem;
      background: var(--dark-card);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 50;
    }
    .topbar-logo {
      font-weight: 700;
      font-size: 1rem;
      background: var(--gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .topbar-nav {
      display: flex;
      gap: 0.25rem;
    }
    .topbar-nav a {
      padding: 0.5rem 1rem;
      border-radius: 999px;
      font-size: 0.85rem;
      color: var(--text-muted);
      transition: all 0.2s;
      font-weight: 500;
    }
    .topbar-nav a:hover { color: var(--text); }
    .topbar-nav a.active {
      background: var(--gradient);
      color: white;
      font-weight: 600;
    }
    .topbar-user {
      font-size: 0.8rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .topbar-user button {
      background: rgba(255, 0, 110, 0.1);
      border: 1px solid rgba(255, 0, 110, 0.3);
      color: var(--pink);
      padding: 0.35rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      cursor: pointer;
      font-weight: 600;
    }

    /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
    .app-layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      min-height: calc(100vh - 52px);
    }
    @media (max-width: 900px) {
      .app-layout { grid-template-columns: 1fr; }
      .sidebar { display: none; }
      .sidebar.mobile-open { display: block; position: fixed; top: 52px; left: 0; right: 0; bottom: 0; z-index: 40; overflow-y: auto; }
    }

    /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
    .sidebar {
      background: var(--dark-card);
      border-right: 1px solid var(--border);
      padding: 1.25rem;
      overflow-y: auto;
    }
    .sidebar-avatar {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: var(--gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      overflow: hidden;
      margin-bottom: 0.75rem;
    }
    .sidebar-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .sidebar-name {
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 0.2rem;
    }
    .sidebar-email {
      font-size: 0.8rem;
      color: var(--text-muted);
      word-break: break-all;
      margin-bottom: 0.75rem;
    }
    .sidebar-plan {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      background: rgba(255, 0, 110, 0.1);
      border: 1px solid rgba(255, 0, 110, 0.2);
      font-size: 0.7rem;
      color: var(--pink);
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    .sidebar-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
      line-height: 1.5;
      margin-bottom: 1rem;
    }
    .trial-banner {
      padding: 0.75rem;
      border-radius: 10px;
      background: rgba(255, 0, 110, 0.06);
      border: 1px dashed rgba(255, 0, 110, 0.4);
      font-size: 0.75rem;
      color: var(--text-dim);
      margin-bottom: 1rem;
      display: none;
    }
    .trial-banner strong { color: var(--pink); }
    .sidebar-actions {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .sidebar-actions button {
      width: 100%;
      padding: 0.5rem;
      border-radius: 999px;
      border: none;
      font-size: 0.8rem;
      cursor: pointer;
      font-weight: 500;
    }
    .btn-upgrade {
      background: var(--gradient);
      color: white;
      font-weight: 600;
    }
    .btn-logout {
      background: rgba(255,255,255,0.05);
      color: var(--text-dim);
      border: 1px solid var(--border) !important;
    }
    .btn-danger {
      background: rgba(255, 50, 50, 0.08);
      color: #ff6b6b;
      font-size: 0.7rem;
    }
    .photo-upload {
      margin: 0.75rem 0;
    }
    .photo-upload label {
      font-size: 0.75rem;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .photo-upload input[type="file"] {
      display: none;
    }

    /* ‚îÄ‚îÄ Main Content ‚îÄ‚îÄ */
    .main-content {
      padding: 1.5rem;
      overflow-y: auto;
    }
    .page { display: none; }
    .page.active { display: block; }

    .card {
      background: var(--dark-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 1.25rem;
    }
    .card h2 {
      font-size: 1.2rem;
      margin-bottom: 0.3rem;
    }
    .card .sub {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 1rem;
    }

    /* ‚îÄ‚îÄ Forms ‚îÄ‚îÄ */
    .form-group { margin-bottom: 0.75rem; }
    .form-group label {
      display: block;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 0.25rem;
    }
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 0.6rem 0.75rem;
      background: var(--dark-input);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 0.9rem;
      font-family: inherit;
    }
    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }
    .form-group select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%239aa3ff' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      padding-right: 2rem;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }
    .btn-submit {
      margin-top: 0.5rem;
      padding: 0.6rem 1.5rem;
      border-radius: 999px;
      border: none;
      background: var(--gradient);
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .btn-submit:hover {
      box-shadow: 0 4px 15px rgba(255, 0, 110, 0.3);
    }

    /* ‚îÄ‚îÄ Browse Grid ‚îÄ‚îÄ */
    .browse-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 1rem;
    }
    .profile-card {
      background: var(--dark-input);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 1rem;
      transition: all 0.2s;
      cursor: pointer;
    }
    .profile-card:hover {
      border-color: rgba(255, 0, 110, 0.3);
      transform: translateY(-2px);
    }
    .profile-card-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.6rem;
    }
    .profile-card-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      overflow: hidden;
      flex-shrink: 0;
    }
    .profile-card-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .profile-card-name {
      font-weight: 600;
      font-size: 0.95rem;
    }
    .profile-card-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
    }
    .profile-card-bio {
      font-size: 0.8rem;
      color: var(--text-dim);
      margin-bottom: 0.6rem;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .profile-card-actions {
      display: flex;
      gap: 0.5rem;
    }
    .profile-card-actions button {
      flex: 1;
      padding: 0.4rem;
      border-radius: 999px;
      border: none;
      font-size: 0.75rem;
      cursor: pointer;
      font-weight: 500;
    }
    .btn-like {
      background: rgba(255, 0, 110, 0.12);
      color: var(--pink);
    }
    .btn-chat {
      background: rgba(131, 56, 236, 0.12);
      color: var(--purple);
    }

    /* ‚îÄ‚îÄ Messages List ‚îÄ‚îÄ */
    .conversations-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .convo-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      background: var(--dark-input);
      border: 1px solid var(--border);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .convo-item:hover {
      border-color: rgba(131, 56, 236, 0.3);
    }
    .convo-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      overflow: hidden;
      flex-shrink: 0;
    }
    .convo-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .convo-info { flex: 1; min-width: 0; }
    .convo-name { font-weight: 600; font-size: 0.9rem; }
    .convo-preview {
      font-size: 0.75rem;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .convo-time {
      font-size: 0.7rem;
      color: var(--text-muted);
      flex-shrink: 0;
    }
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-muted);
      font-size: 0.9rem;
    }
    .empty-state p { margin-bottom: 1rem; }

    /* ‚îÄ‚îÄ Subscription Overlay ‚îÄ‚îÄ */
    .sub-overlay {
      display: none;
      padding: 1.25rem;
      border-radius: 14px;
      border: 1px dashed rgba(255, 0, 110, 0.5);
      background: rgba(255, 0, 110, 0.04);
      margin-bottom: 1rem;
      text-align: center;
    }
    .sub-overlay p {
      font-size: 0.9rem;
      color: var(--text-dim);
      margin-bottom: 0.75rem;
    }
    .sub-overlay .btn-submit { display: inline-block; }

    /* ‚îÄ‚îÄ Profile Detail Modal ‚îÄ‚îÄ */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 100;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .modal-overlay.open { display: flex; }
    .modal-content {
      background: var(--dark-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 2rem;
      max-width: 420px;
      width: 100%;
      position: relative;
    }
    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.2rem;
      cursor: pointer;
    }
    .modal-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      overflow: hidden;
      margin: 0 auto 1rem;
    }
    .modal-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .modal-name { text-align: center; font-size: 1.3rem; font-weight: 700; margin-bottom: 0.25rem; }
    .modal-meta { text-align: center; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1rem; }
    .modal-bio { font-size: 0.9rem; color: var(--text-dim); line-height: 1.5; margin-bottom: 1.25rem; text-align: center; }
    .modal-actions { display: flex; gap: 0.75rem; }
    .modal-actions button {
      flex: 1;
      padding: 0.6rem;
      border-radius: 999px;
      border: none;
      font-size: 0.9rem;
      cursor: pointer;
      font-weight: 600;
    }

    /* ‚îÄ‚îÄ Settings ‚îÄ‚îÄ */
    .settings-section { margin-top: 1rem; }
    .settings-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.85rem;
      color: var(--text-dim);
      margin-top: 0.5rem;
    }
    .settings-row input[type="checkbox"] {
      accent-color: var(--pink);
    }

    /* ‚îÄ‚îÄ Mobile Menu Toggle ‚îÄ‚îÄ */
    .mobile-menu-btn {
      display: none;
      background: none;
      border: none;
      color: var(--text);
      font-size: 1.3rem;
      cursor: pointer;
    }
    @media (max-width: 900px) {
      .mobile-menu-btn { display: block; }
      .topbar-nav { display: none; }
      .topbar-nav.mobile-open { display: flex; position: fixed; top: 52px; left: 0; right: 0; background: var(--dark-card); border-bottom: 1px solid var(--border); padding: 0.75rem; z-index: 45; flex-wrap: wrap; justify-content: center; }
      .form-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <!-- Top Bar -->
  <header class="topbar">
    <a href="/" class="topbar-logo">oodles&doodles</a>
    <button class="mobile-menu-btn" onclick="toggleMobileNav()">&#9776;</button>
    <nav class="topbar-nav" id="topNav">
      <a href="#" data-page="profile" class="active" onclick="showPage('profile',event)">My Profile</a>
      <a href="#" data-page="browse" onclick="showPage('browse',event)">Browse</a>
      <a href="#" data-page="messages" onclick="showPage('messages',event)">Messages</a>
      <a href="#" data-page="settings" onclick="showPage('settings',event)">Settings</a>
    </nav>
    <div class="topbar-user">
      <span id="headerEmail"></span>
      <button onclick="logout()">Logout</button>
    </div>
  </header>

  <div class="app-layout">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-avatar" id="sidebarAvatar">
        <span id="avatarFallback">üòä</span>
        <img id="avatarImg" alt="Profile" style="display:none;">
      </div>
      <div class="sidebar-name" id="sidebarName">Set Up Profile</div>
      <div class="sidebar-email" id="sidebarEmail"></div>

      <div class="photo-upload">
        <label for="photoInput">üì∑ Upload profile photo
          <input type="file" id="photoInput" accept="image/jpeg,image/png,image/webp">
        </label>
      </div>

      <div class="sidebar-plan" id="planBadge">Free Trial</div>
      <div class="sidebar-meta">
        <span>Status: <span id="planStatus">Active</span></span><br>
        <span>Expires: <span id="planExpiry">60 days</span></span>
      </div>

      <div class="trial-banner" id="trialBanner">
        <strong>Trial active</strong> &mdash; <span id="trialDays">60</span> days remaining.
      </div>

      <div class="sidebar-actions">
        <button class="btn-upgrade" onclick="upgradeToStripe()">Upgrade Plan</button>
        <button class="btn-logout" onclick="logout()">Logout</button>
        <button class="btn-danger" onclick="deleteAccount()">Delete Account</button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Subscription Overlay -->
      <div class="sub-overlay" id="subOverlay">
        <p><strong>Your trial has ended.</strong> Renew your subscription to continue browsing and messaging.</p>
        <button class="btn-submit" onclick="upgradeToStripe()">Renew Subscription</button>
      </div>

      <!-- Profile Page -->
      <div class="page active" id="page-profile">
        <div class="card">
          <h2>My Profile</h2>
          <p class="sub">Complete your profile so others can discover you.</p>
          <form onsubmit="saveProfile(event)">
            <div class="form-row">
              <div class="form-group">
                <label for="profileName">Display Name</label>
                <input id="profileName" placeholder="e.g. Danny" required>
              </div>
              <div class="form-group">
                <label for="profileAge">Age</label>
                <input id="profileAge" type="number" min="18" max="120" placeholder="28" required>
              </div>
            </div>
            <div class="form-group">
              <label for="profileLocation">Location</label>
              <input id="profileLocation" placeholder="e.g. Brisbane, QLD">
            </div>
            <div class="form-group">
              <label for="profileBio">Bio</label>
              <textarea id="profileBio" placeholder="Tell others a little about yourself..."></textarea>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="facePreference">Face pics preference</label>
                <select id="facePreference">
                  <option value="no_pref">No preference</option>
                  <option value="faces_only">Only show with face</option>
                  <option value="no_faces">No face pics</option>
                </select>
              </div>
              <div class="form-group">
                <label for="bodyPreference">Body preference</label>
                <select id="bodyPreference">
                  <option value="no_pref">No preference</option>
                  <option value="slim">Slim</option>
                  <option value="average">Average</option>
                  <option value="muscular">Muscular</option>
                  <option value="bigger">Bigger</option>
                </select>
              </div>
            </div>
            <button type="submit" class="btn-submit">Save Profile</button>
          </form>
        </div>
      </div>

      <!-- Browse Page -->
      <div class="page" id="page-browse">
        <div class="card">
          <h2>Browse Profiles</h2>
          <p class="sub">Discover members near you. Only active subscribers and trial members are shown.</p>
          <div class="browse-grid" id="browseGrid">
            <div class="empty-state"><p>Loading profiles...</p></div>
          </div>
        </div>
      </div>

      <!-- Messages Page -->
      <div class="page" id="page-messages">
        <div class="card">
          <h2>Messages</h2>
          <p class="sub">Your recent conversations. Messages are ephemeral and disappear when you log out.</p>
          <div class="conversations-list" id="convoList">
            <div class="empty-state">
              <p>No conversations yet.</p>
              <p>Browse profiles and start chatting!</p>
              <button class="btn-submit" onclick="showPage('browse')">Browse Profiles</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Page -->
      <div class="page" id="page-settings">
        <div class="card">
          <h2>Account Settings</h2>
          <p class="sub">Manage your account, email, and security.</p>
          <form onsubmit="saveSettings(event)">
            <div class="form-group">
              <label for="settingsEmail">Email</label>
              <input id="settingsEmail" type="email" placeholder="your@email.com">
            </div>
            <div class="form-group">
              <label for="settingsPassword">New Password</label>
              <input id="settingsPassword" type="password" placeholder="Leave blank to keep current">
            </div>
            <div class="settings-row">
              <input id="notificationsEnabled" type="checkbox">
              <label for="notificationsEnabled">Enable notifications</label>
            </div>
            <button type="submit" class="btn-submit">Save Settings</button>
          </form>
        </div>

        <div class="card">
          <h2>Subscription</h2>
          <p class="sub">Manage your plan and billing.</p>
          <div class="sidebar-meta">
            Plan: <strong id="settingsPlan">Free Trial</strong><br>
            Status: <strong id="settingsStatus">Active</strong>
          </div>
          <button class="btn-submit" style="margin-top:1rem;" onclick="upgradeToStripe()">Upgrade / Change Plan</button>
        </div>
      </div>
    </main>
  </div>

  <!-- Profile Detail Modal -->
  <div class="modal-overlay" id="profileModal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal()">&times;</button>
      <div class="modal-avatar" id="modalAvatar">
        <span id="modalAvatarFallback">üòä</span>
        <img id="modalAvatarImg" alt="Profile" style="display:none;">
      </div>
      <div class="modal-name" id="modalName"></div>
      <div class="modal-meta" id="modalMeta"></div>
      <div class="modal-bio" id="modalBio"></div>
      <div class="modal-actions">
        <button class="btn-like" id="modalLikeBtn" style="background:rgba(255,0,110,0.12);color:var(--pink);">‚ù§Ô∏è Like</button>
        <button class="btn-chat" id="modalChatBtn" style="background:var(--gradient);color:white;">üí¨ Message</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getAuth, signOut, onAuthStateChanged, updatePassword, updateEmail
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import {
      getFirestore, collection, query, where, getDocs, addDoc, setDoc,
      doc, getDoc, serverTimestamp, deleteDoc, onSnapshot, orderBy, limit
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import {
      getStorage, ref as storageRef, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBVqDVruufVu5AvXBitSoukogADaopR-7A",
      authDomain: "oodlesanddoodles-c9202.firebaseapp.com",
      projectId: "oodlesanddoodles-c9202",
      storageBucket: "oodlesanddoodles-c9202.firebasestorage.app",
      messagingSenderId: "351292337624",
      appId: "1:351292337624:web:5ab5d5bf37b800d0da96ad"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const STRIPE_LINKS = {
      weekly:   "https://buy.stripe.com/28EfZh2CuaTMdnacNT1ZS03",
      monthly:  "https://buy.stripe.com/eVq8wP0um0f80Ao4hn1ZS02",
      yearly:   "https://buy.stripe.com/9B66oH1yq3rk5UIg051ZS01"
    };

    let currentUser = null;
    let currentUserDocId = null;
    let currentUserData = null;
    let allProfiles = [];

    // ‚îÄ‚îÄ‚îÄ Utility ‚îÄ‚îÄ‚îÄ
    function isTrialActive(data) {
      if (!data) return false;
      if (data.isPaid) return true;
      if (!data.trialEnd) return true; // no trial end set = still in trial
      const end = data.trialEnd.seconds
        ? new Date(data.trialEnd.seconds * 1000)
        : new Date(data.trialEnd);
      return end.getTime() >= Date.now();
    }

    function getChatId(uid1, uid2) {
      return [uid1, uid2].sort().join("_");
    }

    // ‚îÄ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ‚îÄ
    window.showPage = (page, e) => {
      if (e) e.preventDefault();
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      const target = document.getElementById('page-' + page);
      if (target) target.classList.add('active');

      document.querySelectorAll('.topbar-nav a').forEach(a => a.classList.remove('active'));
      const link = document.querySelector(`[data-page="${page}"]`);
      if (link) link.classList.add('active');

      if (page === 'browse') loadProfiles();
      if (page === 'messages') loadConversations();
    };

    window.toggleMobileNav = () => {
      document.getElementById('topNav').classList.toggle('mobile-open');
    };

    // ‚îÄ‚îÄ‚îÄ Auth State ‚îÄ‚îÄ‚îÄ
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = '/auth.html';
        return;
      }
      currentUser = user;
      await ensureUserDoc(user.uid, user.email || '');
      loadUserUI();
      loadProfiles();
    });

    async function ensureUserDoc(uid, email) {
      // First try to get doc by UID as document ID
      const directRef = doc(db, 'users', uid);
      const directSnap = await getDoc(directRef);

      if (directSnap.exists()) {
        currentUserDocId = uid;
        currentUserData = directSnap.data();
        return;
      }

      // Fallback: query by uid field
      const q = query(collection(db, 'users'), where('uid', '==', uid));
      const snap = await getDocs(q);

      if (!snap.empty) {
        currentUserDocId = snap.docs[0].id;
        currentUserData = snap.docs[0].data();
        return;
      }

      // Create new user doc with UID as document ID
      const newData = {
        uid,
        email,
        createdAt: serverTimestamp(),
        isPaid: false,
        trialEnd: new Date(Date.now() + 60 * 24 * 60 * 60 * 1000).toISOString(),
        subscriptionTier: 'Free Trial',
        profileName: '',
        age: null,
        bio: '',
        location: '',
        photoURL: '',
        facePreference: 'no_pref',
        bodyPreference: 'no_pref'
      };
      await setDoc(directRef, newData);
      currentUserDocId = uid;
      currentUserData = newData;
    }

    // ‚îÄ‚îÄ‚îÄ UI Updates ‚îÄ‚îÄ‚îÄ
    function loadUserUI() {
      if (!currentUserData || !currentUser) return;
      const d = currentUserData;
      const name = d.profileName || 'Set Up Profile';
      const email = d.email || currentUser.email || '';

      document.getElementById('sidebarName').textContent = name;
      document.getElementById('sidebarEmail').textContent = email;
      document.getElementById('headerEmail').textContent = email;

      // Avatar
      if (d.photoURL) {
        document.getElementById('avatarImg').src = d.photoURL;
        document.getElementById('avatarImg').style.display = 'block';
        document.getElementById('avatarFallback').style.display = 'none';
      }

      // Profile form
      document.getElementById('profileName').value = d.profileName || '';
      document.getElementById('profileAge').value = d.age || '';
      document.getElementById('profileLocation').value = d.location || '';
      document.getElementById('profileBio').value = d.bio || '';
      document.getElementById('facePreference').value = d.facePreference || 'no_pref';
      document.getElementById('bodyPreference').value = d.bodyPreference || 'no_pref';

      // Settings
      document.getElementById('settingsEmail').value = email;

      // Subscription
      const tier = d.subscriptionTier || 'Free Trial';
      const isPaid = !!d.isPaid;
      document.getElementById('planBadge').textContent = tier;
      document.getElementById('settingsPlan').textContent = tier;

      if (isPaid) {
        document.getElementById('planStatus').textContent = 'Active';
        document.getElementById('settingsStatus').textContent = 'Active';
        document.getElementById('planExpiry').textContent = 'Auto-renews';
        document.getElementById('trialBanner').style.display = 'none';
        document.getElementById('subOverlay').style.display = 'none';
      } else if (isTrialActive(d)) {
        document.getElementById('planStatus').textContent = 'Trial';
        document.getElementById('settingsStatus').textContent = 'Trial';
        document.getElementById('trialBanner').style.display = 'block';
        document.getElementById('subOverlay').style.display = 'none';

        let daysLeft = 60;
        if (d.trialEnd) {
          const end = d.trialEnd.seconds
            ? new Date(d.trialEnd.seconds * 1000)
            : new Date(d.trialEnd);
          daysLeft = Math.max(0, Math.ceil((end - Date.now()) / (1000 * 60 * 60 * 24)));
        }
        document.getElementById('trialDays').textContent = daysLeft;
        document.getElementById('planExpiry').textContent = daysLeft + ' days';
      } else {
        document.getElementById('planStatus').textContent = 'Expired';
        document.getElementById('settingsStatus').textContent = 'Expired';
        document.getElementById('planExpiry').textContent = 'Expired';
        document.getElementById('trialBanner').style.display = 'none';
        document.getElementById('subOverlay').style.display = 'block';
      }
    }

    // ‚îÄ‚îÄ‚îÄ Profile Photo Upload ‚îÄ‚îÄ‚îÄ
    document.getElementById('photoInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file || !currentUser) return;
      if (file.size > 5 * 1024 * 1024) { alert('Max 5 MB.'); return; }
      const allowed = ['image/jpeg', 'image/png', 'image/webp'];
      if (!allowed.includes(file.type)) { alert('JPG, PNG, or WEBP only.'); return; }

      try {
        const path = `profilePics/${currentUser.uid}`;
        const ref = storageRef(storage, path);
        await uploadBytes(ref, file);
        const url = await getDownloadURL(ref);
        await setDoc(doc(db, 'users', currentUserDocId), { photoURL: url, updatedAt: serverTimestamp() }, { merge: true });
        currentUserData.photoURL = url;
        document.getElementById('avatarImg').src = url;
        document.getElementById('avatarImg').style.display = 'block';
        document.getElementById('avatarFallback').style.display = 'none';
      } catch (err) {
        console.error(err);
        alert('Upload failed. Try again.');
      }
    });

    // ‚îÄ‚îÄ‚îÄ Save Profile ‚îÄ‚îÄ‚îÄ
    window.saveProfile = async (e) => {
      e.preventDefault();
      if (!currentUser) return;

      const data = {
        uid: currentUser.uid,
        email: currentUser.email || '',
        profileName: document.getElementById('profileName').value.trim(),
        age: parseInt(document.getElementById('profileAge').value) || null,
        location: document.getElementById('profileLocation').value.trim(),
        bio: document.getElementById('profileBio').value.trim(),
        facePreference: document.getElementById('facePreference').value,
        bodyPreference: document.getElementById('bodyPreference').value,
        updatedAt: serverTimestamp()
      };

      await setDoc(doc(db, 'users', currentUserDocId), data, { merge: true });
      Object.assign(currentUserData, data);
      loadUserUI();
      alert('Profile saved!');
      showPage('browse');
    };

    // ‚îÄ‚îÄ‚îÄ Save Settings ‚îÄ‚îÄ‚îÄ
    window.saveSettings = async (e) => {
      e.preventDefault();
      if (!currentUser) return;

      const newEmail = document.getElementById('settingsEmail').value.trim();
      const newPassword = document.getElementById('settingsPassword').value;
      const notifications = document.getElementById('notificationsEnabled').checked;

      try {
        if (newEmail && newEmail !== currentUser.email) {
          await updateEmail(currentUser, newEmail);
        }
        if (newPassword) {
          await updatePassword(currentUser, newPassword);
        }
        await setDoc(doc(db, 'users', currentUserDocId), {
          email: newEmail || currentUser.email,
          notificationsEnabled: notifications,
          updatedAt: serverTimestamp()
        }, { merge: true });
        alert('Settings saved!');
      } catch (err) {
        console.error(err);
        if (err.code === 'auth/requires-recent-login') {
          alert('Please log out and log back in, then try again.');
        } else {
          alert('Error saving settings. Please try again.');
        }
      }
    };

    // ‚îÄ‚îÄ‚îÄ Browse Profiles ‚îÄ‚îÄ‚îÄ
    async function loadProfiles() {
      if (!currentUser || !currentUserData) return;
      const grid = document.getElementById('browseGrid');

      if (!isTrialActive(currentUserData) && !currentUserData.isPaid) {
        grid.innerHTML = '<div class="empty-state"><p>Renew your subscription to browse profiles.</p></div>';
        return;
      }

      grid.innerHTML = '<div class="empty-state"><p>Loading profiles...</p></div>';

      try {
        const q = query(collection(db, 'users'), where('uid', '!=', currentUser.uid));
        const snap = await getDocs(q);
        allProfiles = [];

        snap.forEach(docSnap => {
          const data = docSnap.data();
          if (data.isPaid || isTrialActive(data)) {
            allProfiles.push({ id: docSnap.id, ...data });
          }
        });

        if (allProfiles.length === 0) {
          grid.innerHTML = '<div class="empty-state"><p>No profiles available yet. Check back soon!</p></div>';
          return;
        }

        grid.innerHTML = '';
        allProfiles.slice(0, 500).forEach(user => {
          const name = user.profileName || user.name || 'Anonymous';
          const age = user.age || '?';
          const loc = user.location || 'Somewhere nearby';
          const bio = user.bio || 'No bio yet';
          const photo = user.photoURL || '';

          const card = document.createElement('div');
          card.className = 'profile-card';
          card.onclick = () => openProfileModal(user);
          card.innerHTML = `
            <div class="profile-card-header">
              <div class="profile-card-avatar">
                ${photo ? `<img src="${photo}" alt="${name}">` : 'üòä'}
              </div>
              <div>
                <div class="profile-card-name">${name}, ${age}</div>
                <div class="profile-card-meta">${loc}</div>
              </div>
            </div>
            <div class="profile-card-bio">${bio}</div>
            <div class="profile-card-actions">
              <button class="btn-like" onclick="event.stopPropagation(); likeProfile('${user.uid}')">‚ù§Ô∏è Like</button>
              <button class="btn-chat" onclick="event.stopPropagation(); startChat('${user.uid}')">üí¨ Chat</button>
            </div>
          `;
          grid.appendChild(card);
        });
      } catch (err) {
        console.error(err);
        grid.innerHTML = '<div class="empty-state"><p>Error loading profiles. Please refresh.</p></div>';
      }
    }

    // ‚îÄ‚îÄ‚îÄ Profile Modal ‚îÄ‚îÄ‚îÄ
    window.openProfileModal = (user) => {
      const modal = document.getElementById('profileModal');
      const name = user.profileName || user.name || 'Anonymous';
      const age = user.age || '?';
      const loc = user.location || 'Somewhere nearby';
      const bio = user.bio || 'No bio yet';
      const photo = user.photoURL || '';

      document.getElementById('modalName').textContent = `${name}, ${age}`;
      document.getElementById('modalMeta').textContent = loc;
      document.getElementById('modalBio').textContent = bio;

      if (photo) {
        document.getElementById('modalAvatarImg').src = photo;
        document.getElementById('modalAvatarImg').style.display = 'block';
        document.getElementById('modalAvatarFallback').style.display = 'none';
      } else {
        document.getElementById('modalAvatarImg').style.display = 'none';
        document.getElementById('modalAvatarFallback').style.display = 'flex';
      }

      document.getElementById('modalLikeBtn').onclick = () => { likeProfile(user.uid); closeModal(); };
      document.getElementById('modalChatBtn').onclick = () => { startChat(user.uid); closeModal(); };

      modal.classList.add('open');
    };

    window.closeModal = () => {
      document.getElementById('profileModal').classList.remove('open');
    };

    // Close modal on overlay click
    document.getElementById('profileModal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeModal();
    });

    // ‚îÄ‚îÄ‚îÄ Like / Chat ‚îÄ‚îÄ‚îÄ
    window.likeProfile = async (otherUid) => {
      if (!currentUser) return;
      try {
        await addDoc(collection(db, 'likes'), {
          fromUid: currentUser.uid,
          toUid: otherUid,
          createdAt: serverTimestamp()
        });
        alert('Profile liked! ‚ù§Ô∏è');
      } catch (err) {
        console.error(err);
        alert('Could not like profile. Try again.');
      }
    };

    window.startChat = (otherUid) => {
      if (!currentUser) return;
      window.location.href = `/chat.html?uid=${encodeURIComponent(otherUid)}`;
    };

    // ‚îÄ‚îÄ‚îÄ Load Conversations ‚îÄ‚îÄ‚îÄ
    async function loadConversations() {
      if (!currentUser) return;
      const list = document.getElementById('convoList');
      list.innerHTML = '<div class="empty-state"><p>Loading conversations...</p></div>';

      try {
        const chatsRef = collection(db, 'ephemeralChats');
        const snap = await getDocs(chatsRef);
        const convos = [];

        for (const chatDoc of snap.docs) {
          const data = chatDoc.data();
          if (!data.participants || !data.participants.includes(currentUser.uid)) continue;

          const otherUid = data.participants.find(p => p !== currentUser.uid);
          if (!otherUid) continue;

          // Get other user info
          let otherUser = null;
          const userDoc = await getDoc(doc(db, 'users', otherUid));
          if (userDoc.exists()) {
            otherUser = userDoc.data();
          } else {
            const uq = query(collection(db, 'users'), where('uid', '==', otherUid));
            const uSnap = await getDocs(uq);
            if (!uSnap.empty) otherUser = uSnap.docs[0].data();
          }

          convos.push({
            chatId: chatDoc.id,
            otherUid,
            otherName: otherUser?.profileName || otherUser?.name || 'Anonymous',
            otherPhoto: otherUser?.photoURL || '',
            lastActivity: data.lastActivity
          });
        }

        if (convos.length === 0) {
          list.innerHTML = `
            <div class="empty-state">
              <p>No conversations yet.</p>
              <p>Browse profiles and start chatting!</p>
              <button class="btn-submit" onclick="showPage('browse')">Browse Profiles</button>
            </div>`;
          return;
        }

        list.innerHTML = '';
        convos.forEach(c => {
          const item = document.createElement('div');
          item.className = 'convo-item';
          item.onclick = () => { window.location.href = `/chat.html?uid=${encodeURIComponent(c.otherUid)}`; };
          item.innerHTML = `
            <div class="convo-avatar">
              ${c.otherPhoto ? `<img src="${c.otherPhoto}" alt="${c.otherName}">` : 'üòä'}
            </div>
            <div class="convo-info">
              <div class="convo-name">${c.otherName}</div>
              <div class="convo-preview">Tap to continue chatting</div>
            </div>
          `;
          list.appendChild(item);
        });
      } catch (err) {
        console.error(err);
        list.innerHTML = '<div class="empty-state"><p>Error loading conversations.</p></div>';
      }
    }

    // ‚îÄ‚îÄ‚îÄ Upgrade ‚îÄ‚îÄ‚îÄ
    window.upgradeToStripe = () => {
      window.location.href = '/subscription.html';
    };

    // ‚îÄ‚îÄ‚îÄ Logout ‚îÄ‚îÄ‚îÄ
    window.logout = async () => {
      sessionStorage.clear();
      localStorage.removeItem('oodles_chat_state');
      await signOut(auth);
      window.location.href = '/index.html';
    };

    // ‚îÄ‚îÄ‚îÄ Delete Account ‚îÄ‚îÄ‚îÄ
    window.deleteAccount = () => {
      if (confirm('Are you sure? This cannot be undone.')) {
        alert('Account deletion requested. We will process this within 24 hours.');
      }
    };
  </script>
</body>
</html>
