<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
  import { getAuth, signOut, onAuthStateChanged, updatePassword, updateEmail } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
  import { 
    getFirestore, collection, query, where, getDocs, addDoc, setDoc, doc, serverTimestamp 
  } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBVqDVruufVu5AvXBitSoukogADaopR-7A",
    authDomain: "oodlesanddoodles-c9202.firebaseapp.com",
    projectId: "oodlesanddoodles-c9202",
    storageBucket: "oodlesanddoodles-c9202.firebasestorage.app",
    messagingSenderId: "351292337624",
    appId: "1:351292337624:web:5ab5d5bf37b800d0da96ad"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;
  let currentUserDocId = null;

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = '/index.html';
      return;
    }

    currentUser = user;
    document.getElementById('sidebarEmail').textContent = user.email || '';

    await loadUserData(user.uid);
    await loadProfiles();
  });

  async function loadUserData(uid) {
    const q = query(collection(db, "users"), where("uid", "==", uid));
    const querySnapshot = await getDocs(q);

    if (querySnapshot.empty) {
      // No user doc yet ‚Äì set defaults and create a shell doc
      const docRef = await addDoc(collection(db, "users"), {
        uid,
        email: currentUser.email || '',
        createdAt: serverTimestamp(),
        subscriptionTier: 'Free Trial',
        isPaid: false,
        trialEnd: null
      });
      currentUserDocId = docRef.id;

      document.getElementById('sidebarName').textContent = 'Create Profile';
      document.getElementById('settingsEmail').value = currentUser.email || '';
      document.getElementById('currentPlan').textContent = 'Free Trial';
      document.getElementById('planStatus').textContent = 'Active';
      document.getElementById('planExpiry').textContent = '60 days';
      document.getElementById('nextBilling').textContent = 'TBD';
      document.getElementById('trialBanner').style.display = 'flex';
      return;
    }

    querySnapshot.forEach((docSnap) => {
      currentUserDocId = docSnap.id;
      const data = docSnap.data();

      document.getElementById('sidebarName').textContent = data.profileName || 'Create Profile';
      document.getElementById('profileName').value = data.profileName || '';
      document.getElementById('profileAge').value = data.age || '';
      document.getElementById('profileBio').value = data.bio || '';
      document.getElementById('profileLocation').value = data.location || '';
      document.getElementById('settingsEmail').value = data.email || currentUser.email || '';

      const tier = data.subscriptionTier || 'Free Trial';
      document.getElementById('currentPlan').textContent = tier;
      document.getElementById('planStatus').textContent = data.isPaid ? 'Active' : 'Trial';

      const trialBanner = document.getElementById('trialBanner');
      const trialDaysEl = document.getElementById('trialDays');
      const planExpiryEl = document.getElementById('planExpiry');

      if (!data.isPaid) {
        trialBanner.style.display = 'flex';

        if (data.trialEnd && data.trialEnd.seconds) {
          const trialEnd = new Date(data.trialEnd.seconds * 1000);
          const today = new Date();
          let daysLeft = Math.ceil((trialEnd - today) / (1000 * 60 * 60 * 24));
          if (daysLeft < 0) daysLeft = 0;
          trialDaysEl.textContent = daysLeft;
          planExpiryEl.textContent = daysLeft + ' days';
        } else {
          // Fallback if no trialEnd set
          trialDaysEl.textContent = '60';
          planExpiryEl.textContent = '60 days';
        }
      } else {
        trialBanner.style.display = 'none';
      }
    });
  }

  async function loadProfiles() {
    if (!currentUser) return;

    const q = query(collection(db, "users"), where("uid", "!=", currentUser.uid));
    const querySnapshot = await getDocs(q);

    const browseGrid = document.getElementById('browseGrid');
    browseGrid.innerHTML = '';

    if (querySnapshot.empty) {
      browseGrid.innerHTML = '<p style="color: #aaa;">No profiles available yet. Check back soon!</p>';
      return;
    }

    querySnapshot.forEach((docSnap) => {
      const data = docSnap.data();
      const safeName = data.profileName || 'Anonymous';
      const safeAge = data.age || '?';
      const safeLocation = data.location || 'Location not set';
      const safeBio = data.bio || 'No bio yet';

      const profileHTML = `
        <div class="profile-item" onclick="viewProfile('${docSnap.id}')">
          <div class="profile-item-image">üòä</div>
          <div class="profile-item-info">
            <div class="profile-item-name">${safeName}, ${safeAge}</div>
            <div class="profile-item-age">${safeLocation}</div>
            <div class="profile-item-bio">${safeBio}</div>
            <div class="profile-item-actions">
              <button class="btn-like" onclick="likeProfile(event)">‚ù§Ô∏è Like</button>
              <button class="btn-message" onclick="messageProfile(event)">üí¨ Chat</button>
            </div>
          </div>
        </div>
      `;
      browseGrid.innerHTML += profileHTML;
    });
  }

  // ===== UI handlers attached to window =====

  window.showSection = (section, e) => {
    if (e) e.preventDefault();

    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(section + '-section').classList.add('active');

    document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
    if (e && e.currentTarget) {
      e.currentTarget.classList.add('active');
    }
  };

  window.saveProfile = async (e) => {
    e.preventDefault();
    if (!currentUser) return;

    const profileName = document.getElementById('profileName').value.trim();
    const age = document.getElementById('profileAge').value;
    const bio = document.getElementById('profileBio').value.trim();
    const location = document.getElementById('profileLocation').value.trim();

    if (!currentUserDocId) {
      // Create user doc if missing
      const docRef = await addDoc(collection(db, "users"), {
        uid: currentUser.uid,
        email: currentUser.email || '',
        profileName,
        age,
        bio,
        location,
        updatedAt: serverTimestamp()
      });
      currentUserDocId = docRef.id;
    } else {
      await setDoc(doc(db, "users", currentUserDocId), {
        uid: currentUser.uid,
        email: currentUser.email || '',
        profileName,
        age,
        bio,
        location,
        updatedAt: serverTimestamp()
      }, { merge: true });
    }

    document.getElementById('sidebarName').textContent = profileName || 'Create Profile';
    alert('Profile saved!');
    showSection('browse');
    await loadProfiles();
  };

  window.saveSettings = async (e) => {
    e.preventDefault();
    if (!currentUser) return;

    const newEmail = document.getElementById('settingsEmail').value.trim();
    const newPassword = document.getElementById('settingsPassword').value;

    try {
      if (newEmail && newEmail !== currentUser.email) {
        await updateEmail(currentUser, newEmail);
      }

      if (newPassword) {
        await updatePassword(currentUser, newPassword);
      }

      if (currentUserDocId) {
        await setDoc(doc(db, "users", currentUserDocId), {
          email: newEmail || currentUser.email,
          notificationsEnabled: document.getElementById('notificationsEnabled').checked,
          updatedAt: serverTimestamp()
        }, { merge: true });
      }

      alert('Settings saved!');
    } catch (err) {
      console.error(err);
      alert('There was an error updating your settings. Please re‚Äëlogin and try again.');
    }
  };

  window.logout = async () => {
    await signOut(auth);
    window.location.href = '/index.html';
  };

  window.upgradeToStripe = (checkoutUrl) => {
    window.location.href = checkoutUrl;
  };

  window.likeProfile = (e) => {
    e.stopPropagation();
    alert('Profile liked! üíñ');
  };

  window.messageProfile = (e) => {
    e.stopPropagation();
    alert('Chat coming soon! üí¨');
  };

  window.viewProfile = (profileId) => {
    alert('Profile details loading...');
  };

  window.deleteAccount = () => {
    if (confirm('Are you sure? This cannot be undone.')) {
      alert('Account deletion requested. We\'ll process this within 24 hours.');
    }
  };
</script>
