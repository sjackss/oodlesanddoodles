<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Oodles & Doodles – App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://js.stripe.com/v3/"></script>
</head>
<body class="bg-slate-100 text-slate-900">
  <div class="min-h-screen flex flex-col">
    <header class="px-4 py-3 bg-white border-b border-slate-200 flex items-center justify-between">
      <div>
        <h1 class="text-lg font-bold">Oodles & Doodles</h1>
        <p class="text-xs text-slate-500">Gay Dating Without the Bullshit</p>
      </div>
      <div class="flex gap-2">
        <button class="px-3 py-1 text-sm rounded-md bg-slate-900 text-white" onclick="showTab('signup')">Sign up / Billing</button>
        <button class="px-3 py-1 text-sm rounded-md bg-slate-100" onclick="showTab('profile')">Profile</button>
        <button class="px-3 py-1 text-sm rounded-md bg-slate-100" onclick="showTab('browse')">Browse</button>
        <button class="px-3 py-1 text-sm rounded-md bg-slate-100" onclick="showTab('messages')">Messages</button>
      </div>
    </header>

    <main class="flex-1 p-4 space-y-4">

      <!-- SIGNUP / BILLING -->
      <section id="tab-signup" class="space-y-4">
        <h2 class="text-xl font-semibold">Sign up & choose your plan</h2>
        <div class="bg-white rounded-xl shadow-sm p-4 space-y-3 max-w-md">
          <div>
            <label class="block text-sm font-medium mb-1">Email</label>
            <input id="signup-email" type="email" class="w-full border rounded-md px-3 py-2 text-sm" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Password</label>
            <input id="signup-password" type="password" class="w-full border rounded-md px-3 py-2 text-sm" />
          </div>
          <p class="text-xs text-slate-500">
            After choosing a plan you’ll be taken to Stripe Checkout to add your card and start your subscription.
          </p>
          <div class="flex flex-wrap gap-2">
            <button class="px-3 py-2 text-sm rounded-md bg-emerald-600 text-white" onclick="startSignup('trial')">7‑Day Trial</button>
            <button class="px-3 py-2 text-sm rounded-md bg-sky-600 text-white" onclick="startSignup('weekly')">Weekly</button>
            <button class="px-3 py-2 text-sm rounded-md bg-indigo-600 text-white" onclick="startSignup('monthly')">Monthly</button>
            <button class="px-3 py-2 text-sm rounded-md bg-amber-600 text-white" onclick="startSignup('lifetime')">Lifetime</button>
          </div>
          <p id="signup-status" class="text-xs text-rose-600"></p>
        </div>
      </section>

      <!-- PROFILE -->
      <section id="tab-profile" class="space-y-4 hidden">
        <h2 class="text-xl font-semibold">Your profile</h2>
        <div class="bg-white rounded-xl shadow-sm p-4 space-y-3 max-w-xl">
          <div>
            <label class="block text-sm font-medium mb-1">Display name</label>
            <input id="profile-name" type="text" class="w-full border rounded-md px-3 py-2 text-sm" />
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1">Age</label>
              <input id="profile-age" type="number" class="w-full border rounded-md px-3 py-2 text-sm" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Location</label>
              <input id="profile-location" type="text" class="w-full border rounded-md px-3 py-2 text-sm" />
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Position preference</label>
            <select id="profile-position" class="w-full border rounded-md px-3 py-2 text-sm">
              <option value="">Select…</option>
              <option value="top">Top</option>
              <option value="bottom">Bottom</option>
              <option value="vers">Vers</option>
              <option value="side">Side</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Bio</label>
            <textarea id="profile-bio" rows="3" class="w-full border rounded-md px-3 py-2 text-sm"></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Profile photo URL (simple version)</label>
            <input id="profile-photo" type="url" class="w-full border rounded-md px-3 py-2 text-sm" />
            <p class="text-xs text-slate-500">
              Later you can replace this with a real uploader; for now paste an image URL to test.
            </p>
          </div>
          <button class="px-4 py-2 rounded-md bg-slate-900 text-white text-sm" onclick="saveProfile()">Save profile</button>
          <p id="profile-status" class="text-xs text-emerald-600"></p>
        </div>
      </section>

      <!-- BROWSE -->
      <section id="tab-browse" class="space-y-4 hidden">
        <h2 class="text-xl font-semibold">Browse guys near you</h2>
        <button class="px-3 py-1.5 text-sm rounded-md bg-slate-900 text-white" onclick="loadUsers()">Refresh list</button>
        <div id="browse-list" class="grid gap-3 md:grid-cols-2 lg:grid-cols-3"></div>
      </section>

      <!-- MESSAGES -->
      <section id="tab-messages" class="space-y-4 hidden">
        <h2 class="text-xl font-semibold">Messages</h2>
        <div class="grid grid-cols-3 gap-3">
          <div class="col-span-1 bg-white rounded-xl shadow-sm p-3">
            <p class="text-sm font-medium mb-2">Conversations</p>
            <!-- Simple placeholder: in real app, load chats for user -->
            <ul id="chat-list" class="space-y-1 text-sm">
              <li><button class="w-full text-left px-2 py-1 rounded hover:bg-slate-100" onclick="openChat('demo-chat','Demo User')">Demo User</button></li>
            </ul>
          </div>
          <div class="col-span-2 bg-white rounded-xl shadow-sm flex flex-col">
            <div class="border-b px-3 py-2 flex items-center justify-between">
              <span id="chat-with" class="text-sm font-medium">Select a chat</span>
            </div>
            <div id="chat-messages" class="flex-1 px-3 py-2 space-y-2 overflow-y-auto text-sm"></div>
            <div class="border-t px-3 py-2 space-y-2">
              <textarea id="chat-input" rows="2" class="w-full border rounded-md px-2 py-1 text-sm" placeholder="Type a message…"></textarea>
              <div class="flex items-center justify-between">
                <span class="text-xs text-slate-500">Simple text demo; media and voice can be added later.</span>
                <button class="px-3 py-1.5 text-sm rounded-md bg-slate-900 text-white" onclick="sendMessage()">Send</button>
              </div>
            </div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <script>
    const stripe = Stripe('pk_live_REPLACE_ME'); // your Stripe publishable key
    const FAKE_USER_ID = 1; // replace with real auth later
    let currentChatId = null;

    function showTab(name) {
      ['signup', 'profile', 'browse', 'messages'].forEach(tab => {
        document.getElementById('tab-' + tab).classList.toggle('hidden', tab !== name);
      });
    }

    async function startSignup(plan) {
      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;
      if (!email || !password) {
        document.getElementById('signup-status').textContent = 'Email and password required.';
        return;
      }
      document.getElementById('signup-status').textContent = 'Creating checkout session…';

      const res = await fetch('/api/create-checkout-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, plan }),
      });

      const data = await res.json();
      if (!data.id) {
        document.getElementById('signup-status').textContent = 'Error starting checkout.';
        return;
      }

      const { error } = await stripe.redirectToCheckout({ sessionId: data.id });
      if (error) {
        document.getElementById('signup-status').textContent = error.message;
      }
    }

    async function saveProfile() {
      const body = {
        user_id: FAKE_USER_ID,
        display_name: document.getElementById('profile-name').value,
        age: Number(document.getElementById('profile-age').value || 0),
        location: document.getElementById('profile-location').value,
        position_pref: document.getElementById('profile-position').value,
        photo_url: document.getElementById('profile-photo').value,
        bio: document.getElementById('profile-bio').value,
      };

      const res = await fetch('/api/api-users', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });

      if (res.ok) {
        document.getElementById('profile-status').textContent = 'Profile saved.';
      } else {
        document.getElementById('profile-status').textContent = 'Error saving profile.';
      }
    }

    async function loadUsers() {
      const container = document.getElementById('browse-list');
      container.innerHTML = 'Loading…';

      const res = await fetch('/api/api-users');
      const users = await res.json();

      container.innerHTML = '';
      users.forEach(u => {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-xl shadow-sm p-3 flex flex-col gap-2';
        card.innerHTML = `
          <div class="flex gap-3">
            <div class="w-12 h-12 rounded-full bg-slate-200 overflow-hidden">
              ${u.photo_url ? `<img src="${u.photo_url}" class="w-full h-full object-cover" />` : ''}
            </div>
            <div>
              <p class="text-sm font-semibold">${u.display_name || 'Unknown'}</p>
              <p class="text-xs text-slate-500">${u.age || '?'} · ${u.location || ''}</p>
              <p class="text-xs text-slate-500">${u.position_pref || ''}</p>
            </div>
          </div>
          <p class="text-xs text-slate-700 line-clamp-3">${u.bio || ''}</p>
          <button class="mt-1 px-3 py-1.5 text-xs rounded-md bg-slate-900 text-white" onclick="openChat('chat-' + ${u.id}, '${u.display_name || 'User'}')">Chat</button>
        `;
        container.appendChild(card);
      });
    }

    function openChat(chatId, name) {
      currentChatId = chatId;
      document.getElementById('chat-with').textContent = name;
      document.getElementById('chat-messages').innerHTML = '';
      loadMessages();
    }

    async function loadMessages() {
      if (!currentChatId) return;
      const res = await fetch('/api/api-messages?chat_id=' + encodeURIComponent(currentChatId));
      const msgs = await res.json();
      const box = document.getElementById('chat-messages');
      box.innerHTML = '';
      msgs.forEach(m => {
        const div = document.createElement('div');
        div.className = 'max-w-xs px-2 py-1 rounded-md text-sm ' +
          (m.from_user_id === FAKE_USER_ID ? 'bg-slate-900 text-white ml-auto' : 'bg-slate-100');
        div.textContent = m.text;
        box.appendChild(div);
      });
      box.scrollTop = box.scrollHeight;
    }

    async function sendMessage() {
      if (!currentChatId) return;
      const text = document.getElementById('chat-input').value.trim();
      if (!text) return;
      document.getElementById('chat-input').value = '';

      await fetch('/api/api-messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          chat_id: currentChatId,
          from_user_id: FAKE_USER_ID,
          to_user_id: 999, // placeholder
          text,
          image_url: null,
          audio_url: null,
        }),
      });

      loadMessages();
    }
  </script>
</body>
</html>
